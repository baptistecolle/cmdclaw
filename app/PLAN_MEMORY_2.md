# Plan: Missing Memory Features (Session Lifecycle + Compaction)

This plan documents the two missing areas from `openclaw-memory.md` and what to add in HeyBap.

References
- HeyBap: `src/server/services/generation-manager.ts`, `src/server/services/memory-service.ts`, `src/app/api/internal/memory/route.ts`, `src/e2b-template/plugins/memory.ts`
- OpenClaw:
  - Session memory hook: `openclaw/src/hooks/bundled/session-memory/handler.ts`
  - Session transcript indexing: `openclaw/src/memory/manager.ts`, `openclaw/src/memory/session-files.ts`, `openclaw/src/memory/sync-session-files.ts`
  - Compaction hooks: `openclaw/src/plugins/hooks.ts`
  - Memory flush policy: `openclaw/src/auto-reply/reply/memory-flush.ts`

## Feature 1: Session lifecycle hooks + session transcript storage

### What OpenClaw does
- On `/new`, a hook writes a *session summary file* into `memory/` using the last N messages and a slug generated by an LLM.
  - Source: `openclaw/src/hooks/bundled/session-memory/handler.ts`
- Session transcripts are stored and indexed as part of memory search.
  - Source: `openclaw/src/memory/manager.ts`, `openclaw/src/memory/session-files.ts`, `openclaw/src/memory/sync-session-files.ts`

### What HeyBap currently does
- No `/new` hook.
- No transcript files written on session end/reset.
- Memory search only sees memory entries written via `memory_write`.

### What to add (HeyBap)
1) **Session lifecycle trigger**
   - Decide where `/new` is handled (CLI or app command). Add a hook that fires when a conversation is reset or a new session is started.
   - Capture last N messages from `message` table (suggest default: 15).

2) **Session transcript storage**
   - Create a new memory entry or file for each session boundary.
   - Suggested path format for daily memory: `memory/YYYY-MM-DD-<slug>.md` or store in DB with `type=daily` + `title` + `tags`.
   - Include metadata: session id, conversation id, timestamp, source.

3) **Slug generation (optional, OpenClaw-style)**
   - Use an LLM call to build a slug from the last N messages. Fallback to `HHMM` if missing.

4) **Indexing**
   - Ensure these session transcript entries are chunked/embedded like regular memory entries.
   - If stored as DB entries, this is automatic via existing `memory_write` flow.

### Concrete HeyBap touchpoints
- Add a “session boundary” handler near conversation resets (likely in `generation-manager.ts` or a controller handling `/new`).
- Add a helper in `memory-service.ts` to write session summaries (or reuse `writeMemoryEntry`).
- Optional: add a small config block to control message count + enable/disable.

---

## Feature 2: Compaction + pre-compaction memory flush + pruning

### What OpenClaw does
- **Compaction:** reduces long histories by summarizing older turns.
- **Memory flush before compaction:** a silent LLM turn that writes durable info to memory, then compaction runs.
- **Hooks:** plugins can run `before_compaction` / `after_compaction`.
  - Sources: `openclaw/src/plugins/hooks.ts`, `openclaw/src/auto-reply/reply/memory-flush.ts`

### What HeyBap currently does
- No compaction trigger.
- No memory-flush turn.
- No pruning of tool output.

### What to add (HeyBap)
1) **Compaction trigger + policy**
   - Add a token budget check in the generation loop.
   - If tokens exceed threshold, run compaction.
   - Store summary as a new message (e.g., system or assistant) and drop older messages from the prompt.

2) **Pre-compaction memory flush**
   - Add a dedicated flush step when approaching the compaction threshold.
   - Use a prompt like OpenClaw’s `DEFAULT_MEMORY_FLUSH_PROMPT`/`SYSTEM_PROMPT` and require `NO_REPLY`.
   - Execute the same tool loop (so `memory_write` can run) but do not send output to the user.

3) **Compaction hooks**
   - Add hooks in the OpenCode plugin for `before_compaction`/`after_compaction` so it mirrors OpenClaw’s hook model.
   - If OpenCode already emits `experimental.session.compacting`/`session.compacted`, wire to that.

4) **Pruning (optional phase 2)**
   - Add pruning policy for very large tool outputs or cache TTL outputs (like OpenClaw “cache-ttl”).
   - This can be a preprocessing step before compaction, not required for v1.

### Concrete HeyBap touchpoints
- `src/server/services/generation-manager.ts`:
  - Add token accounting for message history.
  - Add compaction flow (summary generation + message replacement).
  - Add pre-compaction memory flush run.
- `src/e2b-template/plugins/memory.ts`:
  - Optionally add a hook to run on OpenCode compaction events.

---

## Suggested order of implementation
1) Session lifecycle hook + transcript entry write (low risk, no model changes).
2) Pre-compaction memory flush (hook + silent LLM turn + `memory_write`).
3) Compaction summarization + prompt replacement.
4) Optional pruning policy.

## OpenClaw decisions (apply to HeyBap)
- Session transcripts are a separate source from memory (OpenClaw indexes `sessions` separately from `memory`). Do not store session transcripts via `memory_write`; store them as a distinct DB source/type.
- Compaction summaries live inside session transcripts (message history), not in durable memory. Only the pre-compaction memory flush writes to memory.
- `/new` is the manual trigger in OpenClaw
